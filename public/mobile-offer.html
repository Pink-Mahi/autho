<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Make Offer - Bitcoin Ownership Protocol</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 15px 20px;
      border-bottom: 2px solid #d4af37;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: none;
      border: none;
      color: #d4af37;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      font-weight: 700;
      color: #d4af37;
      flex: 1;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .item-summary {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .item-summary-title {
      font-family: 'Playfair Display', serif;
      font-size: 18px;
      color: #d4af37;
      margin-bottom: 5px;
    }

    .item-summary-serial {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #999;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(212, 175, 55, 0.3);
      border-radius: 10px;
      padding: 15px;
      color: #ffffff;
      font-size: 16px;
    }

    .input:focus {
      outline: none;
      border-color: #d4af37;
    }

    .input-hint {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }

    .price-preview {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
      color: #1a1a1a;
    }

    .price-preview-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
      opacity: 0.7;
    }

    .price-preview-value {
      font-family: 'Playfair Display', serif;
      font-size: 36px;
      font-weight: 700;
    }

    .price-preview-sats {
      font-size: 14px;
      margin-top: 5px;
      opacity: 0.7;
    }

    .btn {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #1a1a1a;
      border: none;
      border-radius: 12px;
      padding: 15px 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn.secondary {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      border: 2px solid #d4af37;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .info-box {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-box-title {
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-box-text {
      font-size: 13px;
      color: #ccc;
      line-height: 1.6;
    }

    .offer-details {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .offer-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .offer-row:last-child {
      border-bottom: none;
    }

    .offer-label {
      font-size: 13px;
      color: #999;
    }

    .offer-value {
      font-size: 14px;
      color: #d4af37;
      font-weight: 600;
    }

    .payment-status {
      background: rgba(76, 217, 100, 0.1);
      border: 2px solid #4cd964;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .payment-status-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .payment-status-title {
      font-size: 18px;
      font-weight: 600;
      color: #4cd964;
      margin-bottom: 5px;
    }

    .payment-status-text {
      font-size: 13px;
      color: #ccc;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid #d4af37;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tx-link {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #d4af37;
      word-break: break-all;
      margin-top: 10px;
      padding: 10px;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <h1>Make Offer</h1>
  </div>

  <div class="container">
    <!-- Offer Form Screen -->
    <div id="offerFormScreen" class="screen active">
      <div class="item-summary">
        <div class="item-summary-title" id="itemName">Loading...</div>
        <div class="item-summary-serial" id="itemSerial">SN: ...</div>
      </div>

      <div class="info-box">
        <div class="info-box-title">üí° How It Works</div>
        <div class="info-box-text">
          Make an offer to the current owner. If accepted, you'll pay via Bitcoin and ownership transfers automatically once confirmed.
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Your Offer (USD)</label>
        <input type="number" id="offerAmount" class="input" placeholder="0.00" step="0.01" min="0" oninput="updatePreview()">
        <div class="input-hint">Enter amount in USD</div>
      </div>

      <div class="input-group">
        <label class="input-label">Offer Expires In</label>
        <select id="offerExpiry" class="input">
          <option value="3600">1 hour</option>
          <option value="21600">6 hours</option>
          <option value="86400" selected>24 hours</option>
          <option value="259200">3 days</option>
          <option value="604800">7 days</option>
        </select>
      </div>

      <div class="price-preview" id="pricePreview" style="display: none;">
        <div class="price-preview-label">You'll Pay</div>
        <div class="price-preview-value" id="previewUSD">$0</div>
        <div class="price-preview-sats" id="previewSats">0 sats</div>
      </div>

      <button class="btn" onclick="submitOffer()" id="submitOfferBtn" disabled>Submit Offer</button>
      <button class="btn secondary" onclick="goBack()">Cancel</button>
    </div>

    <!-- Review Offer Screen -->
    <div id="reviewOfferScreen" class="screen">
      <div class="item-summary">
        <div class="item-summary-title" id="reviewItemName">Item Name</div>
        <div class="item-summary-serial" id="reviewItemSerial">SN: ...</div>
      </div>

      <div class="offer-details">
        <div class="offer-row">
          <span class="offer-label">Your Offer</span>
          <span class="offer-value" id="reviewOfferUSD">$0</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Amount in BTC</span>
          <span class="offer-value" id="reviewOfferSats">0 sats</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Seller Receives</span>
          <span class="offer-value" id="reviewSellerAmount">0 sats (60%)</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Operator Fees</span>
          <span class="offer-value" id="reviewOperatorFees">0 sats (40%)</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Expires</span>
          <span class="offer-value" id="reviewExpiry">24 hours</span>
        </div>
      </div>

      <div class="info-box">
        <div class="info-box-title">üîê Secure Payment</div>
        <div class="info-box-text">
          Once the seller accepts, you'll be prompted to sign and broadcast the Bitcoin payment. Ownership transfers automatically after confirmation.
        </div>
      </div>

      <button class="btn" onclick="confirmOffer()">Confirm & Sign Offer</button>
      <button class="btn secondary" onclick="showScreen('offerFormScreen')">Edit Offer</button>
    </div>

    <!-- Offer Submitted Screen -->
    <div id="offerSubmittedScreen" class="screen">
      <div class="payment-status">
        <div class="payment-status-icon">‚úÖ</div>
        <div class="payment-status-title">Offer Submitted</div>
        <div class="payment-status-text">Waiting for seller to accept your offer</div>
      </div>

      <div class="offer-details">
        <div class="offer-row">
          <span class="offer-label">Offer ID</span>
          <span class="offer-value" id="submittedOfferId">...</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Amount</span>
          <span class="offer-value" id="submittedAmount">$0</span>
        </div>
        <div class="offer-row">
          <span class="offer-label">Status</span>
          <span class="offer-value">Pending</span>
        </div>
      </div>

      <button class="btn" onclick="viewMyOffers()">View My Offers</button>
      <button class="btn secondary" onclick="goToHome()">Back to Home</button>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen">
      <div class="loading">
        <div class="spinner"></div>
        <div id="loadingText">Processing...</div>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('itemId');
    let currentItem = null;
    let btcRate = 40000; // Mock BTC/USD rate

    window.goBack = () => {
      window.history.back();
    };

    window.goToHome = () => {
      window.location.href = '/m';
    };

    window.viewMyOffers = () => {
      window.location.href = '/m/offers';
    };

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // Load item details
    async function loadItem() {
      if (!itemId) {
        alert('No item specified');
        goBack();
        return;
      }

      try {
        const response = await fetch(`/api/registry/item/${encodeURIComponent(itemId)}`);
        if (!response.ok) throw new Error('Item not found');
        
        currentItem = await response.json();
        document.getElementById('itemName').textContent = currentItem.itemType || 'Unknown Item';
        document.getElementById('itemSerial').textContent = `SN: ${currentItem.serialNumber || itemId}`;
        
        // Load BTC rate
        await loadBTCRate();
      } catch (error) {
        console.error('Error loading item:', error);
        alert('Failed to load item details');
        goBack();
      }
    }

    async function loadBTCRate() {
      try {
        // In production, fetch from price API
        // For now, use mock rate
        btcRate = 40000;
      } catch (error) {
        console.log('Using default BTC rate');
      }
    }

    window.updatePreview = () => {
      const usdAmount = parseFloat(document.getElementById('offerAmount').value) || 0;
      
      if (usdAmount > 0) {
        const sats = Math.floor((usdAmount / btcRate) * 100000000);
        
        document.getElementById('pricePreview').style.display = 'block';
        document.getElementById('previewUSD').textContent = `$${usdAmount.toFixed(2)}`;
        document.getElementById('previewSats').textContent = `${sats.toLocaleString()} sats`;
        document.getElementById('submitOfferBtn').disabled = false;
      } else {
        document.getElementById('pricePreview').style.display = 'none';
        document.getElementById('submitOfferBtn').disabled = true;
      }
    };

    window.submitOffer = () => {
      const usdAmount = parseFloat(document.getElementById('offerAmount').value);
      const expiry = parseInt(document.getElementById('offerExpiry').value);
      
      if (!usdAmount || usdAmount <= 0) {
        alert('Please enter a valid offer amount');
        return;
      }

      // Check wallet
      const wallet = localStorage.getItem('autho_wallet');
      if (!wallet) {
        alert('Please create a wallet first');
        window.location.href = '/m/wallet';
        return;
      }

      // Calculate amounts
      const sats = Math.floor((usdAmount / btcRate) * 100000000);
      const sellerAmount = Math.floor(sats * 0.6);
      const operatorFees = sats - sellerAmount;

      // Populate review screen
      document.getElementById('reviewItemName').textContent = currentItem.itemType || 'Unknown Item';
      document.getElementById('reviewItemSerial').textContent = `SN: ${currentItem.serialNumber || itemId}`;
      document.getElementById('reviewOfferUSD').textContent = `$${usdAmount.toFixed(2)}`;
      document.getElementById('reviewOfferSats').textContent = `${sats.toLocaleString()} sats`;
      document.getElementById('reviewSellerAmount').textContent = `${sellerAmount.toLocaleString()} sats (60%)`;
      document.getElementById('reviewOperatorFees').textContent = `${operatorFees.toLocaleString()} sats (40%)`;
      
      const expiryHours = expiry / 3600;
      document.getElementById('reviewExpiry').textContent = 
        expiryHours < 24 ? `${expiryHours} hours` : `${expiryHours / 24} days`;

      showScreen('reviewOfferScreen');
    };

    window.confirmOffer = async () => {
      showScreen('loadingScreen');
      document.getElementById('loadingText').textContent = 'Creating offer...';

      try {
        const wallet = JSON.parse(localStorage.getItem('autho_wallet'));
        const usdAmount = parseFloat(document.getElementById('offerAmount').value);
        const expiry = parseInt(document.getElementById('offerExpiry').value);
        const sats = Math.floor((usdAmount / btcRate) * 100000000);

        // Get item details
        const itemResponse = await fetch(`/api/registry/item/${encodeURIComponent(itemId)}`);
        const itemData = await itemResponse.json();

        // Submit offer to API
        const response = await fetch('/api/offers/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            itemId: itemId,
            buyerAddress: wallet.address,
            amount: usdAmount,
            sats: sats,
            expiresIn: expiry * 1000,
            itemName: itemData.itemType || 'Unknown Item'
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to submit offer');
        }

        const result = await response.json();
        
        // Show success
        document.getElementById('submittedOfferId').textContent = result.offerId;
        document.getElementById('submittedAmount').textContent = `$${usdAmount.toFixed(2)}`;
        document.getElementById('submittedSats').textContent = `${sats.toLocaleString()} sats`;
        document.getElementById('paymentAddress').textContent = result.offer.paymentAddress;
        
        showScreen('offerSubmittedScreen');
      } catch (error) {
        console.error('Error submitting offer:', error);
        alert('Failed to submit offer: ' + error.message);
        showScreen('reviewOfferScreen');
      }
    };

    // Load item on page load
    window.addEventListener('load', () => {
      loadItem();
    });
  </script>
</body>
</html>
